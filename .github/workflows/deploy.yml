# GitHub Actions è‡ªåŠ¨éƒ¨ç½²åˆ°é˜¿é‡Œäº‘ ECS
# å½“æ¨é€åˆ° main åˆ†æ”¯æ—¶è‡ªåŠ¨è§¦å‘éƒ¨ç½²

name: Deploy to Aliyun ECS

on:
  push:
    branches:
      - main
  workflow_dispatch:  # å…è®¸æ‰‹åŠ¨è§¦å‘

jobs:
  deploy:
    runs-on: ubuntu-latest
    name: Deploy to Production

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Deploy to Aliyun ECS
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.ECS_HOST }}
          username: ${{ secrets.ECS_USERNAME }}
          key: ${{ secrets.ECS_SSH_KEY }}
          port: ${{ secrets.ECS_PORT || 22 }}
          script: |
            echo "ğŸš€ å¼€å§‹éƒ¨ç½² sysafari-customer-portal..."
            
            # è¿›å…¥é¡¹ç›®ç›®å½•
            cd /var/www/sysafari-portal
            
            # æ‹‰å–æœ€æ–°ä»£ç 
            echo "ğŸ“¥ æ‹‰å–æœ€æ–°ä»£ç ..."
            git pull origin main
            
            # å®‰è£…å‰ç«¯ä¾èµ–å¹¶æ„å»º
            echo "ğŸ“¦ å®‰è£…å‰ç«¯ä¾èµ–..."
            npm ci --production=false
            
            echo "ğŸ”¨ æ„å»ºå‰ç«¯..."
            npm run build
            
            # å¤åˆ¶æ„å»ºæ–‡ä»¶åˆ° Nginx æœåŠ¡ç›®å½•
            echo "ğŸ“‚ éƒ¨ç½²å‰ç«¯æ–‡ä»¶åˆ° Nginx..."
            cp -r /var/www/sysafari-portal/dist/* /var/www/portal/
            
            # å®‰è£…åç«¯ä¾èµ–
            echo "ğŸ“¦ å®‰è£…åç«¯ä¾èµ–..."
            cd server
            npm ci --production
            cd ..
            
            # é‡å¯ PM2 æœåŠ¡
            echo "ğŸ”„ é‡å¯æœåŠ¡..."
            pm2 restart portal-api || pm2 start server/app.js --name portal-api
            
            echo "âœ… éƒ¨ç½²å®Œæˆï¼"

      - name: Deployment Status
        if: always()
        run: |
          if [ "${{ job.status }}" == "success" ]; then
            echo "âœ… éƒ¨ç½²æˆåŠŸï¼"
          else
            echo "âŒ éƒ¨ç½²å¤±è´¥ï¼Œè¯·æ£€æŸ¥æ—¥å¿—"
          fi

